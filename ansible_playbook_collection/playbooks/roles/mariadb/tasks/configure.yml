---
# Configure MySQL server

- name: Setup my cnf for root
  become: yes
  template: src=my.cnf.j2 dest=/root/.my.cnf owner=root mode=0600
  run_once: true

- name: Open MySQL to all hosts
  become: yes
  lineinfile:
    dest: /etc/mysql/my.cnf
    regexp: "^bind-address"
    line: "bind-address = {{ mysql_bind_address }}"

- name: Start server to generate mysql schema
  become: yes
  service: name=mysql state=started
  run_once: true

- name: Wait for service
  wait_for: port={{ mysql_port }} delay=5 timeout=21
  run_once: true

- block:
    - name: Change root user password on first run
      mysql_user: login_user=root
                  login_password=''
                  name=root
                  password={{ root_password }}
                  priv=*.*:ALL,GRANT
                  host={{ item }}
      with_items:
        - "%"
        - "127.0.0.1"
        - "::1"
        - "{{ ansible_hostname }}"
        - "localhost"
      run_once: true
    
    - name: Delete anonymous user
      mysql_user: login_user=root
                  login_password={{ root_password }}
                  name=''
                  host={{ item }}
                  state='absent'
      with_items:
        - "127.0.0.1"
        - "localhost"
        - "%"
        - "{{ ansible_hostname }}"
      run_once: true
    
    - name: Delete test database
      mysql_db: login_user=root
                login_password={{ root_password }}
                name=test
                state='absent'
      run_once: true
      tags: mariadb-delete-test

  rescue:
    - debug: msg="Cannot access to MySQL using default credential. Suppose that root password has been already configured."
