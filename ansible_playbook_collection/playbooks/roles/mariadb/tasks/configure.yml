---
# Configure MySQL server

- name: Setup my cnf for root
  become: yes
  template: src=my.cnf.j2 dest=/root/.my.cnf owner=root mode=0600
  run_once: true

- name: Start server to generate mysql schema
  become: yes
  service: name=mysql state=started
  run_once: true

- name: standby during restart service
  wait_for: port={{ mysql_port }} delay=5 timeout=21
  run_once: true

- name: Change root user password on first run
  mysql_user: login_user=root
              login_password=''
              name=root
              password={{ root_password }}
              priv=*.*:ALL,GRANT
              host={{ item }}
  with_items:
    - "%"
    - "127.0.0.1"
    - "::1"
    - "{{ ansible_hostname }}"
    - "localhost"
  ignore_errors: yes
  run_once: true

- name: Delete anonymous user
  mysql_user: login_user=root
              login_password={{ root_password }}
              name=''
              host={{ item }}
              state='absent'
  with_items:
    - "127.0.0.1"
    - "localhost"
    - "%"
    - "{{ ansible_hostname }}"
  ignore_errors: yes
  run_once: true

- name: Delete test database
  mysql_db: login_user=root
            login_password={{ root_password }}
            name=test
            state='absent'
  ignore_errors: yes
  run_once: true
  tags: mariadb-delete-test
